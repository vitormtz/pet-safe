<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PetSafe - Gerenciar Dispositivos">
    <title>Meus Dispositivos - PetSafe</title>

    <link rel="icon" type="image/x-icon" th:href="@{/images/icone_01.ico}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>
    <div th:replace="~{fragments/header :: navbar}"></div>

    <div class="container py-5" style="margin-top: 80px;">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="fw-bold mb-2">Meus Dispositivos</h1>
                        <p class="text-muted mb-0">Gerencie os rastreadores e dispositivos conectados à sua conta</p>
                    </div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#deviceModal"
                        onclick="openAddModal()">
                        <i class="bi bi-plus-circle me-2"></i>Adicionar Dispositivo
                    </button>
                </div>
            </div>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row g-4" th:if="${devices != null and !devices.isEmpty()}">
            <div class="col-md-6 col-lg-4" th:each="device : ${devices}">
                <div class="card device-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="device-icon">
                                <i class="bi bi-geo-alt-fill text-primary" style="margin-top: 6px;"></i>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item edit-device-btn" href="#"
                                            th:data-device-id="${device.id}"
                                            th:data-serial-number="${device.serialNumber}" th:data-imei="${device.imei}"
                                            th:data-model="${device.model}" th:data-firmware="${device.firmware}"
                                            th:data-active="${device.active}">
                                            <i class="bi bi-pencil me-2"></i>Editar
                                        </a>
                                    </li>
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger delete-device-btn" href="#"
                                            th:data-device-id="${device.id}"
                                            th:data-serial-number="${device.serialNumber}">
                                            <i class="bi bi-trash me-2"></i>Excluir
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <h5 class="card-title fw-bold mb-2" th:text="${device.serialNumber}">Serial do Dispositivo</h5>

                        <div class="device-info">
                            <div class="info-item">
                                <i class="bi bi-hdd-fill text-primary"></i>
                                <span>
                                    <strong>Modelo:</strong>
                                    <span th:text="${device.model}">Modelo</span>
                                </span>
                            </div>
                            <div class="info-item" th:if="${device.imei != null and !device.imei.isEmpty()}">
                                <i class="bi bi-phone-fill text-success"></i>
                                <span>
                                    <strong>IMEI:</strong>
                                    <span th:text="${device.imei}">IMEI</span>
                                </span>
                            </div>
                            <div class="info-item">
                                <i class="bi bi-battery-half text-info"></i>
                                <span>
                                    <strong>Status:</strong>
                                    <span th:classappend="${device.active ? 'text-success' : 'text-danger'}"
                                        th:text="${device.active ? 'Ativo' : 'Inativo'}">Ativo/Inativo</span>
                                </span>
                            </div>
                            <div class="info-item" th:if="${device.lastComm != null}">
                                <i class="bi bi-clock-fill text-warning"></i>
                                <span>
                                    <strong>Última Com.:</strong>
                                    <span th:text="${#temporals.format(device.lastComm, 'dd/MM/yyyy HH:mm:ss')}">Data</span>
                                </span>
                            </div>
                            <div class="info-item" th:if="${device.lastLatitude != null and device.lastLongitude != null}">
                                <i class="bi bi-pin-map-fill text-danger"></i>
                                <span>
                                    <strong>Última Coord.:</strong>
                                    <span th:text="${#numbers.formatDecimal(device.lastLatitude, 1, 4) + ', ' + #numbers.formatDecimal(device.lastLongitude, 1, 4)}">Coordenadas</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center py-5" th:if="${devices == null or devices.isEmpty()}">
            <i class="bi bi-truck display-1 text-muted mb-3"></i>
            <h3 class="text-muted">Nenhum dispositivo cadastrado</h3>
            <p class="text-muted mb-0">Adicione um rastreador para começar a usar o sistema</p>
        </div>
    </div>

    <div class="modal fade" id="deviceModal" tabindex="-1" aria-labelledby="deviceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deviceModalLabel">Adicionar Dispositivo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="deviceForm" th:action="@{/devices}" method="post" th:object="${deviceRequest}">
                    <input type="hidden" id="deviceId" name="deviceId">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="serialNumber" class="form-label">Número Serial *</label>
                            <input type="text" class="form-control" id="serialNumber" name="serialNumber" th:field="*{serialNumber}" required>
                        </div>

                        <div class="mb-3">
                            <label for="model" class="form-label">Modelo</label>
                            <input type="text" class="form-control" id="model" name="model" th:field="*{model}">
                        </div>

                        <div class="mb-3">
                            <label for="imei" class="form-label">IMEI</label>
                            <input type="text" class="form-control" id="imei" name="imei" th:field="*{imei}">
                        </div>

                        <div class="mb-3">
                            <label for="firmware" class="form-label">Firmware</label>
                            <input type="text" class="form-control" id="firmware" name="firmware" th:field="*{firmware}">
                        </div>
                        
                        <div class="mb-3" id="activeField" style="display:none;">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="active" name="active" th:field="*{active}">
                                <label class="form-check-label" for="active">Dispositivo Ativo</label>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmar Exclusão
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir o dispositivo com Serial <strong id="deleteDeviceSerial"></strong>?</p>
                    <p class="text-muted mb-0">Esta ação não pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <form id="deleteForm" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash me-2"></i>Excluir
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Função para abrir modal de adicionar
        function openAddModal() {
            document.getElementById('deviceModalLabel').innerText = 'Adicionar Dispositivo';
            document.getElementById('deviceForm').action = '/devices';
            document.getElementById('deviceId').value = '';
            document.getElementById('serialNumber').value = '';
            document.getElementById('model').value = '';
            document.getElementById('imei').value = '';
            document.getElementById('firmware').value = '';
            document.getElementById('submitBtn').innerText = 'Salvar';

            // O campo 'Ativo' só aparece na edição
            document.getElementById('activeField').style.display = 'none';
            document.getElementById('serialNumber').readOnly = false; // Serial editável na Criação
        }

        // Event listeners para botões de editar e excluir
        document.addEventListener('DOMContentLoaded', function () {
            // Editar dispositivo
            document.querySelectorAll('.edit-device-btn').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();

                    const id = this.getAttribute('data-device-id');
                    const serialNumber = this.getAttribute('data-serial-number');
                    const imei = this.getAttribute('data-imei') || '';
                    const model = this.getAttribute('data-model') || '';
                    const firmware = this.getAttribute('data-firmware') || '';
                    const active = this.getAttribute('data-active') === 'true';

                    document.getElementById('deviceModalLabel').innerText = 'Editar Dispositivo';
                    document.getElementById('deviceForm').action = '/devices/' + id + '/update';
                    document.getElementById('deviceId').value = id;
                    document.getElementById('serialNumber').value = serialNumber;
                    document.getElementById('model').value = model;
                    document.getElementById('imei').value = imei;
                    document.getElementById('firmware').value = firmware;
                    document.getElementById('submitBtn').innerText = 'Atualizar';

                    // Preenche o campo 'Ativo'
                    document.getElementById('active').checked = active;
                    document.getElementById('activeField').style.display = 'block'; // Mostra o campo
                    document.getElementById('serialNumber').readOnly = true; // Serial não deve ser alterado na edição

                    const modal = new bootstrap.Modal(document.getElementById('deviceModal'));
                    modal.show();
                });
            });

            // Excluir dispositivo
            document.querySelectorAll('.delete-device-btn').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();

                    const id = this.getAttribute('data-device-id');
                    const serialNumber = this.getAttribute('data-serial-number');

                    document.getElementById('deleteDeviceSerial').innerText = serialNumber;
                    document.getElementById('deleteForm').action = '/devices/' + id + '/delete';

                    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
                    modal.show();
                });
            });
        });
    </script>
</body>
</html>